<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fredonia Hub</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <main class="wrap">
   <div class="brand">The Howard Homestead LLC</div>
<h1>FREDONIA, PA 16124</h1>

    <section class="panel" aria-label="Time and weather">
      <div class="row">
        <div class="block">
          <div class="label">Eastern Standard Time</div>
          <div class="clock" id="clockTime">--:--</div>
          <div class="date" id="clockDate">Loading date…</div>
        </div>

        <section class="panel" aria-label="3-day forecast" style="margin-top:14px;">
  <div class="label">3-Day Forecast</div>
  <div class="forecast" id="forecast3">
    <div class="small">Loading forecast…</div>
  </div>
</section>

        <div class="block right">
          <div class="label">Current Temp (16124)</div>
          <div class="temp" id="tempF">--°F</div>
          <div class="small" id="tempMeta">Syncing…</div>
        </div>
      </div>

      <div class="small status" id="syncStatus">Syncing time…</div>
    </section>
  </main>

  <script>
    (function () {
      // ---------- Time ("atomic" via internet sync) ----------
      const timeEl = document.getElementById("clockTime");
      const dateEl = document.getElementById("clockDate");
      const syncEl = document.getElementById("syncStatus");

      let offsetMs = 0;      // serverTime - localTime
      let lastTimeSync = 0;

      function formatTimeToMinute(d){
        return new Intl.DateTimeFormat("en-US", {
          timeZone: "America/New_York",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        }).format(d);
      }

      function formatDate(d){
        return new Intl.DateTimeFormat("en-US", {
          timeZone: "America/New_York",
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric"
        }).format(d);
      }

      function renderTime(){
        const now = new Date(Date.now() + offsetMs);
        timeEl.textContent = formatTimeToMinute(now);
        dateEl.textContent = formatDate(now);

        if (lastTimeSync) {
          const ageSec = Math.floor((Date.now() - lastTimeSync) / 1000);
          syncEl.textContent = `Time synced ${ageSec}s ago`;
        }
      }

      async function syncTime(){
  // Time.Now (free, CORS-enabled, “atomic synchronized”)
  // Docs: https://time.now/developer/api/timezone/America/New_York
  try {
    const r = await fetch("https://time.now/developer/api/timezone/America/New_York", { cache: "no-store" });
    if (!r.ok) throw new Error("time.now HTTP " + r.status);
    const j = await r.json();

    // j.unixtime is seconds since epoch
    const serverMs = (j.unixtime * 1000);
    offsetMs = serverMs - Date.now();
    lastTimeSync = Date.now();

    // Optional: show abbreviation (EST/EDT) in the status line
    // This keeps your label "Eastern Standard Time" as requested,
    // while still showing what's actually active right now.
    const abbr = j.abbreviation ? ` (${j.abbreviation})` : "";
    syncEl.textContent = "Time synced" + abbr;
  } catch (e) {
    syncEl.textContent = "Time sync failed (showing device time)";
    offsetMs = 0;
  }
}

      // ---------- Temperature (16124 → geocode → current temp) ----------
      const tempEl = document.getElementById("tempF");
      const tempMetaEl = document.getElementById("tempMeta");

      let lastTempSync = 0;
      let cachedLat = null;
      let cachedLon = null;
      let cachedName = "16124";

      async function geocodeZip(){
        // Open-Meteo geocoding: searching postal code as "name"
        const url = "https://geocoding-api.open-meteo.com/v1/search?name=16124&count=1&language=en&format=json&country=US";
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("Geocode HTTP " + r.status);
        const j = await r.json();
        const loc = j && j.results && j.results[0];
        if (!loc) throw new Error("No geocode result for 16124");
        cachedLat = loc.latitude;
        cachedLon = loc.longitude;
        cachedName = loc.name || "16124";
      }

      async function syncTemp(){
        try {
          if (cachedLat === null || cachedLon === null) {
            await geocodeZip();
          }
          const url =
            "https://api.open-meteo.com/v1/forecast" +
            `?latitude=${encodeURIComponent(cachedLat)}` +
            `&longitude=${encodeURIComponent(cachedLon)}` +
            "&current=temperature_2m" +
            "&temperature_unit=fahrenheit" +
            "&timezone=America%2FNew_York";

          const r = await fetch(url, { cache: "no-store" });
          if (!r.ok) throw new Error("Weather HTTP " + r.status);
          const j = await r.json();
          const t = j && j.current && j.current.temperature_2m;

          if (typeof t === "number") {
            tempEl.textContent = `${Math.round(t)}°F`;
            lastTempSync = Date.now();
            tempMetaEl.textContent = `Synced · ${cachedName}`;
          } else {
            tempMetaEl.textContent = "Temp unavailable";
          }
        } catch (e) {
          tempMetaEl.textContent = "Temp sync failed";
        }
      }

      // ---------- Run ----------
      // Time: render continuously, resync periodically
      syncTime().finally(() => {
        renderTime();
        setInterval(renderTime, 1000);           // smooth updates (still shows minute precision)
        setInterval(syncTime, 10 * 60 * 1000);   // resync every 10 min
      });

      // Temp: sync now + every 10 minutes
      syncTemp();
      setInterval(syncTemp, 10 * 60 * 1000);
    })();
  </script>
</body>
</html>
