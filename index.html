<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fredonia Hub</title>
<link rel="stylesheet" href="styles.css"/>
</head>

<body>
<main class="wrap">

<div class="brand">The Howard Homestead LLC</div>
<h1>FREDONIA, PA 16124</h1>

<section class="panel">
<div class="row">

<div class="block">
<div class="label">Eastern Standard Time</div>
<div class="clock" id="clockTime">--:--</div>
<div class="date" id="clockDate">Loading dateâ€¦</div>
<div class="small" id="syncStatus">Syncingâ€¦</div>
</div>

<div class="block right">
<div class="label">Current Conditions</div>

<div class="condRow">
<img id="condIcon" class="condIcon" src=""/>
<div>
<div class="temp" id="tempF">--Â°F</div>
<div class="small" id="condText">Loadingâ€¦</div>
<div class="small" id="rh">RH: --%</div>
<div class="small" id="windNow">Wind: --</div>
<div class="small" id="moonText">Moon: --</div>
</div>
<img id="moonIcon" class="moonIcon" src=""/>
</div>

<div class="small" id="tempMeta">Syncingâ€¦</div>
</div>

</div>
</section>

<section class="panel">
<div class="label">3-Day Forecast</div>
<div class="forecastGrid" id="forecast3">
<div class="small">Loading forecastâ€¦</div>
</div>
</section>

</main>

<script>
(function(){

/* ---------- CLOCK (12-hour) ---------- */
const timeEl=document.getElementById("clockTime");
const dateEl=document.getElementById("clockDate");
const syncEl=document.getElementById("syncStatus");

let offsetMs=0;
let lastTimeSync=0;

function formatTime(d){
return new Intl.DateTimeFormat("en-US",{
timeZone:"America/New_York",
hour:"numeric",
minute:"2-digit",
hour12:true
}).format(d);
}

function formatDate(d){
return new Intl.DateTimeFormat("en-US",{
timeZone:"America/New_York",
weekday:"long",
year:"numeric",
month:"long",
day:"numeric"
}).format(d);
}

function renderTime(){
const now=new Date(Date.now()+offsetMs);
timeEl.textContent=formatTime(now);
dateEl.textContent=formatDate(now);
}

async function syncTime(){
try{
const r=await fetch("https://time.now/developer/api/timezone/America/New_York",{cache:"no-store"});
const j=await r.json();
offsetMs=(j.unixtime*1000)-Date.now();
lastTimeSync=Date.now();
syncEl.textContent="Time synced";
}catch{
syncEl.textContent="Device time";
offsetMs=0;
}
}

/* ---------- WEATHER CURRENT ---------- */
const tempEl=document.getElementById("tempF");
const rhEl=document.getElementById("rh");
const windEl=document.getElementById("windNow");
const condTextEl=document.getElementById("condText");
const condIconEl=document.getElementById("condIcon");
const moonTextEl=document.getElementById("moonText");
const moonIconEl=document.getElementById("moonIcon");
const tempMetaEl=document.getElementById("tempMeta");

let cachedLat=null;
let cachedLon=null;

async function geocodeZip(){
const r=await fetch("https://geocoding-api.open-meteo.com/v1/search?name=16124&count=1&country=US");
const j=await r.json();
cachedLat=j.results[0].latitude;
cachedLon=j.results[0].longitude;
}

function moonPhase(phase){
if(phase===0) return ["New Moon","ðŸŒ‘"];
if(phase<0.25) return ["Waxing Crescent","ðŸŒ’"];
if(phase===0.25) return ["First Quarter","ðŸŒ“"];
if(phase<0.5) return ["Waxing Gibbous","ðŸŒ”"];
if(phase===0.5) return ["Full Moon","ðŸŒ•"];
if(phase<0.75) return ["Waning Gibbous","ðŸŒ–"];
if(phase===0.75) return ["Last Quarter","ðŸŒ—"];
return ["Waning Crescent","ðŸŒ˜"];
}

async function syncTemp(){
try{
if(cachedLat===null) await geocodeZip();

const r=await fetch(
`https://api.open-meteo.com/v1/forecast?latitude=${cachedLat}&longitude=${cachedLon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m&daily=moon_phase&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America%2FNew_York`
);
const j=await r.json();
const c=j.current;

tempEl.textContent=Math.round(c.temperature_2m)+"Â°F";
rhEl.textContent="RH: "+Math.round(c.relative_humidity_2m)+"%";
windEl.textContent=`Wind: ${Math.round(c.wind_direction_10m)}Â° ${Math.round(c.wind_speed_10m)} mph`;

const condMap={
0:["Clear","https://api.weather.gov/icons/land/day/skc?size=medium"],
1:["Mostly Clear","https://api.weather.gov/icons/land/day/few?size=medium"],
2:["Partly Cloudy","https://api.weather.gov/icons/land/day/sct?size=medium"],
3:["Cloudy","https://api.weather.gov/icons/land/day/ovc?size=medium"],
61:["Rain","https://api.weather.gov/icons/land/day/rain?size=medium"],
71:["Snow","https://api.weather.gov/icons/land/day/snow?size=medium"],
95:["Storm","https://api.weather.gov/icons/land/day/tsra?size=medium"]
};

const cond=condMap[c.weather_code]||["Conditions","https://api.weather.gov/icons/land/day/ovc?size=medium"];
condTextEl.textContent=cond[0];
condIconEl.src=cond[1];

const m=moonPhase(j.daily.moon_phase[0]);
moonTextEl.textContent="Moon: "+m[0];
moonIconEl.src="https://em-content.zobj.net/thumbs/120/apple/354/"+encodeURIComponent(m[1])+".png";

tempMetaEl.textContent="Synced";

}catch{
tempMetaEl.textContent="Weather sync failed";
}
}

/* ---------- FORECAST ---------- */
const forecastWrap=document.getElementById("forecast3");

async function fetchJSON(url){
const r=await fetch(url,{headers:{Accept:"application/geo+json"}});
return r.json();
}

async function syncForecast(){
try{

if(cachedLat===null) await geocodeZip();

const point=await fetchJSON(`https://api.weather.gov/points/${cachedLat},${cachedLon}`);
const forecast=await fetchJSON(point.properties.forecast);
const grid=await fetchJSON(point.properties.forecastGridData);

const gustSeries=grid.properties.windGust?.values||[];

const periods=forecast.properties.periods;
const days=new Map();
const now=new Date();

for(const p of periods){
const start=new Date(p.startTime);
if(start<now) continue;

const key=start.toDateString();
if(!days.has(key)) days.set(key,{day:null,night:null});

const e=days.get(key);
if(p.isDaytime && !e.day) e.day=p;
if(!p.isDaytime && !e.night) e.night=p;

if(days.size>=3 && e.day && e.night) break;
}

forecastWrap.innerHTML="";

Array.from(days.values()).slice(0,3).forEach(e=>{

const hi=e.day?`${e.day.temperature}Â°F`:"â€”";
const lo=e.night?`${e.night.temperature}Â°F`:"â€”";
const icon=(e.day&&e.day.icon)||(e.night&&e.night.icon)||"";
const name=(e.day&&e.day.name)||(e.night&&e.night.name)||"Forecast";
const pop=(e.day?.probabilityOfPrecipitation?.value ?? e.night?.probabilityOfPrecipitation?.value);
const wind=(e.day?.windDirection+" "+e.day?.windSpeed)||"â€”";

forecastWrap.insertAdjacentHTML("beforeend",`
<div class="fcard">
<div class="fday">${name}</div>
<div class="frow">
<img class="ficon" src="${icon}"/>
<div class="fmeta">
<div class="fhilow"><b>Hi:</b> ${hi} &nbsp; <b>Lo:</b> ${lo}</div>
<div><b>PoP:</b> ${pop??"â€”"}%</div>
<div><b>Wind:</b> ${wind}</div>
</div>
</div>
</div>
`);
});

}catch{
forecastWrap.innerHTML='<div class="small">Forecast load failed.</div>';
}
}

/* ---------- RUN ---------- */
syncTime().finally(()=>{
renderTime();
setInterval(renderTime,1000);
setInterval(syncTime,600000);
});

syncTemp();
setInterval(syncTemp,600000);

syncForecast();
setInterval(syncForecast,1800000);

})();
</script>

</body>
</html>
